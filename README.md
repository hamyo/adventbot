# Телеграм-бот для адвент-календаря

Это телеграм-бот для адвент-календаря и проведения квестов. 


## Возможности

Поддерживается два режима (триггера) для начала ежедневных заданий:
 1. по любому сообщению от участника;
 2. по существующему коду.

Существующие типы заданий.
 1. Решение за администратором. Задача, где решение о выполнении принимает администратор.
 2. Ответ от кого-нибудь. Задача, где нужен ответ определенного типа от любого участника (не администратора).
 3. Ответ от всех. Задача, где нужен ответ определенного типа от всех участников (не администраторов).
 4. Текстовый ответ. Задача, где нужен текстовый ответ, соответствующий правильному значению.
 5. Быки и коровы. Задача 'Быки и коровы', где нужно угадать загаданное число из 4 цифр. Цифры не повторяются.

Поддерживаемые типы контента, которые могут быть отправлены участникам или получены от участников в качестве ответа:

 1. Изображение.
 2. Аудиофайл.
 3. Голосовое сообщение.
 4. Видео.
 5. Текст.
 6. Gif-анимация.
 7. Документ.

## Работа с проектом
После клона проекта нужно собрать jar с помощью gradle. Для сборки вызовите из папки с приложением команду `gradlew.bat bootJar`(для Windows) или `./gradlew bootJar`(для Linux/macOS).

В директории с проектом в файле .env указываются необходимые значения.
<br/>`POSTGRES_USER` и `POSTGRES_PASSWORD` - данные пользователя СУБД Postgres. Можно не менять. 
<br/>`POSTGRES_DB_PATH` - путь к папке, где будут лежать базы Postgres.
<br/>`APP_PORT` - порт приложения. Можно не указывать.
<br/>`TELEGRAM_BOT_TOKEN` - токен для телеграм-бота. Будет получен при создании бота через [@BotFather](https://t.me/BotFather).
Контейнер с образами приложения и базы создаётся и запускается командой из папки приложения
`docker-compose up`

## Как пользоваться
Создание и изменение адвента выполняется через сообщения в личном чате администратора и бота. Для рассылки заданий необходимо создать группу с участниками и ботом. Для чтения сообщений из группового чата бота нужно сделать администратором.

### Создание адвента
После корректного запуска и развертывания, нужно добавить администратора. В личных сообщениях адвент-боту отправляем сообщение `/admin/add`. Команда работает только один раз пока нет других пользователей. Если администратор был успешно добавлен, то появится сообщение "Администратор  {Ваше имя или имя пользователя из телеграма} (id={Ваш ID из телеграма}) успешно добавлен".
Отправляем команду `/advents` и получаем список незавершенных и завершенных (но не ранее 5 дней назад) адвентов. Максимальное количество возвращаемых адвентов - 5. Список отсортирован по убыванию даты начала. 

После этого можно создать новый адвент или изменить существующий, выбрав нужный пункт из меню, привязанному к сообщению в телеграме. Взаимодействие с ботом (создание и изменение данных для адвента) выполняется через команды из меню.

После создания адвента нужно создать: 
 - участников. Для этого нужны их id и имена. Для определения id участнику можно использовать телеграм-бот [@getmyid_bot](https://t.me/getmyid_bot)
 - шаги с заданиями (подробнее см. раздел Шаг)
 - коды, если это адвент по существующему коду. Создавать необязательно - коды также генерируются сами при добавлении нового дня в адвент. Может пригодится, если уже подходит время начала адвента, а задания ещё не все придуманы

### Выгрузка информации по адвенту
Созданный адвент можно проверить, выгрузив полную информацию по нему. Это пункт меню "Полная информация". В результате будут выполнены проверки:
 - в каждом дне есть задание;
 - никакой день не пропущен;
 - шаги идут по порядку без пропусков;
Проверки (особенно вторая и третья) носят скорее информативный характер и не мешают проведению адвента. Возможно, что это сделано специально, но следует обратить внимание.

Также будет выгружена информация по участникам и подробная информация по шагам (текст, контент, тип задания (если есть) и подсказки). По каждому дню адвента информация выгружается в отдельном архиве, содержащем файл с информацией и файлы контента. Процесс идёт асинхронно, поэтому дни могут быть выгружены не по порядку.

### Проведение адвента
Для начала в чате группы администратору необходимо ввести команду `/setchatid`. Это свяжет последний адвент без id чата с чатом группы.

Следующая команда от администратора `/start`. Это выведет приветственное сообщение из адвента в чат группы. На старт адвента это не влияет.

Для начала каждого дня адвента одному из участников нужно в зависимости от типа адвента ввести любое сообщение или заранее определенный код. Начало всего адвента указывается при создании - раньше времени он не начнётся.

## Шаг
Шаг адвента - это сообщение, которое может быть отправлено пользователю. Это может быть текстовое сообщение, контент определенного типа с подписью или задание. В рамках дня указывается порядок, по которому шаги отправляются участникам. Шаги отправляются до первого попавшегося задания. После отправки задания бот ждёт результата в зависимости от типа задания. После получения ожидаемого ответа, отправка шагов продолжится по тому же принципу. В рамках одного дня может быть несколько заданий. Например, несколько заданий-ребусов.

При создании шага выбирается тип задания или вариант без задания. Атрибуты и формат ввода будет зависеть от выбранного типа. После создания шага можно загрузить контент. К шагу может быть привязан только один файл.
